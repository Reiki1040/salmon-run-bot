# サーモンラン スケジュール自動通知 (クマサン商会)

これは、スプラ3のサーモンランのスケジュールを自動で取得し、指定したDiscordチャンネルにWebhookを利用して通知するシステムです。

## 主な特徴

このシステムは、単に通知を送るだけでなく、長期間の安定稼働を実現するための様々な機能を実装しています。

- **全自動・自律運用**
  - シフトの通知が完了すると、自動的に**次のシフトの開始時刻をAPIから取得**し、次の通知を予約します。  
  このサイクルにより、一度起動すれば半永久的に動作し続けます。

- **高い信頼性と堅牢性**
  - **APIリトライ機能**: 外部APIやDiscordが一時的に不安定になっても、時間をおいて再試行し、通知の失敗を防ぎます。
  - **重複投稿防止**: 最後に通知したシフトを記憶し、万が一トリガーが重複しても同じ内容が投稿されることはありません。
  - **毎時のバックアップ実行**: メインの時限トリガーとは別に、1時間ごとのバックアップトリガーが通知漏れを確実に補正します。

- **不規則なスケジュールにも対応**
  - スケジュールの間隔を計算するのではなく、常にAPIから**絶対的な開始日時**を取得してトリガーを設定するため、ビッグランなどでスケジュール間隔が不規則になっても問題なく動作します。

- **外部ライブラリ不要**
  - GASの標準機能のみで構築。セットアップがシンプル。

## 準備するもの

- Googleアカウント
- 通知を送信したいDiscordサーバーと、そこでWebhookを作成できる権限

## セットアップ手順

1.  **Google Apps Scriptプロジェクトの作成**
    - [Google Apps Script](https://script.google.com/)にアクセスし、新しいプロジェクトを作成します。
    - `コード.gs`などのファイルに、このリポジトリのスクリプト内容をすべてコピペします。

2.  **Discord Webhook URLの取得**
    - Discordサーバーの `サーバー設定` > `連携サービス` > `ウェブフック` を開き、「新しいウェブフック」を作成。
    - 作成したWebhookの「Webhook URLをコピー」ボタンを押し、URLを控えておきます。**このURLは絶対に外部に公開しないように。**

3.  **スクリプトプロパティの設定**
    - GASエディタの左側メニューから `プロジェクトの設定` (歯車アイコン) を開きます。
    - 「スクリプト プロパティ」のセクションで、「スクリプト プロパティを追加」をクリックし、以下の必須プロパティを設定します。

| プロパティ名 | 値 | 説明 |
| :--- | :--- | :--- |
| `discordWebhookUrl` | (手順2でコピーしたURL) | 通知を送信するDiscordのWebhook URL。 |

4.  **初回起動**
    - GASエディタ上部で、実行したい関数から `bootstrap` を選択します。
    - `▶ 実行` ボタンを押します。
    - 初回実行時にはGoogleアカウントへのアクセス許可を求めるポップアップが表示されるので、内容を確認して承認してください。
    - これで、最初のトリガーが設定され、全自動運用が開始されます。

## オプション設定

以下のスクリプトプロパティを追加で設定することで、動作をカスタマイズできます。

| プロパティ名 | 値の例 | 説明 |
| :--- | :--- | :--- |
| `preNotifyMin` | `15` | シフト開始の何分前に事前通知を行うかを設定します（分単位）。`0`または未設定の場合は無効|
| `avatarUrl` | `https://.../icon.png` | Webhookで投稿する際のアイコン画像のURLを指定 |
| `userAgent` | `MyBot/1.0` | APIにアクセスする際のUser-Agent文字列です。通常は変更不要 |

## 手動で実行できる関数

GASエディタから手動で実行することで、特定の操作を行えます。

- `bootstrap()`
  - **初回セットアップ時に一度だけ実行します。** 次のシフトに合わせて必要なトリガーをすべて設定します。
- `postNextThreeShiftsWithWeapons()`
  - 現在の時点から直近3シフト分のスケジュールを、Discordに即時投稿します。  
  これはデバッグ用に作成したので使うことはほとんどないです。
- `postShiftNowForce()`
  - 重複防止を無視して、現在のシフト情報を強制的に通知します。  
   これもデバッグや動作確認に使用。

## 動作の仕組み

このスクリプトは、`ScriptApp.newTrigger().timeBased().at(date)` を利用して、次のシフトが開始する**時刻そのもの**をピンポイントで指定してトリガーを設定。

`postShiftNow`関数が実行されて通知が成功すると、その処理の最後に`setNextTriggers`関数が呼び出される。`setNextTriggers`は、既存のトリガーを一度すべてクリアした後、APIから**次回以降シフト開始時刻**を取得し、新しいトリガーを設定。  
この連鎖により、スクリプトは自律的に動作を継続する。

また、`LockService` を利用することで、複数のトリガーがほぼ同時に実行された場合でも処理が競合しないように制御。

## 注意事項

- このスクリプトは非公式の外部API `https://spla3.yuu26.com/api` を利用しています。  
API提供者の都合により、サービスが停止したり仕様が変更されたりした場合、このスクリプトは正常に動作しなくなる可能性があります。